<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMAP - Professor</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/professor-dashboard.css">
    <link rel="shortcut icon" type="imagex/png" href="images/logo-unipam 2.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- ==================== HEADER MOBILE ==================== -->
    <header class="mobile-header">
        <div class="header-top">
            <button class="menu-hamburger" onclick="toggleMenu()">‚ò∞</button>
            <h1>UNIMAP - Professor</h1>
            <span class="user-name" id="mobileUserName">Professor</span>
        </div>

        <nav class="mobile-nav" id="mobileNav">
            <div class="nav-user" id="mobileNavUser">
                <i class="fas fa-chalkboard-teacher"></i> Professor
            </div>
            <a href="#" onclick="showSection('minhas-aulas-professor')" class="active">
                <i class="fas fa-chalkboard-teacher"></i> Minhas Aulas
            </a>
            <a href="#" onclick="showSection('criar-aula')">
                <i class="fas fa-plus-circle"></i> Criar Nova Aula
            </a>
            <a href="#" onclick="showSection('mapa-blocos')">
                <i class="fas fa-door-open"></i> Mapa de Salas
            </a>
            <a href="#" onclick="authManager.logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </nav>
    </header>

    <!-- ==================== HEADER DESKTOP ==================== -->
    <header class="desktop-header">
        <div class="header-content">
            <a href="professor-dashboard.html" class="logo-link">
                <img src="images/unipam png.png" alt="UNIPAM" class="navbar-logo">
                <h1>UNIMAP - Professor</h1>
            </a>
            <nav class="desktop-nav">
                <a href="#" onclick="showSection('minhas-aulas-professor')" class="nav-link active">
                    <i class="fas fa-chalkboard-teacher"></i> Minhas Aulas
                </a>
                <a href="#" onclick="showSection('criar-aula')" class="nav-link">
                    <i class="fas fa-plus-circle"></i> Criar Aula
                </a>
                <a href="#" onclick="showSection('mapa-blocos')" class="nav-link">
                    <i class="fas fa-door-open"></i> Mapa Salas
                </a>
                <span class="user-info" id="desktopUserName">
                    <i class="fas fa-user"></i> Professor
                </span>
                <button class="btn-sair-desktop-texto" onclick="authManager.logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </nav>
        </div>
    </header>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main>
        <!-- ==================== SE√á√ÉO: MINHAS AULAS ==================== -->
        <section id="minhas-aulas-professor" class="section active">
            <div class="professor-page-header">
                <h2><i class="fas fa-chalkboard-teacher"></i> Minhas Aulas</h2>
                <button class="btn-primary" onclick="showSection('criar-aula')">
                    <i class="fas fa-plus-circle"></i> Nova Aula
                </button>
            </div>

            <!-- Container de Filtros -->
            <div class="filtros-container">
                <div class="filtros-header">
                    <h3 class="filtros-title">
                        <i class="fas fa-filter"></i> Filtros de Busca
                    </h3>
                    <div id="contadorAulas" class="contador-aulas">Total: 0 aulas</div>
                </div>

                <div class="filtros-grid">
                    <!-- Filtro por Disciplina -->
                    <div class="filtro-group">
                        <label for="filtroDisciplina" class="filtro-label">
                            <i class="fas fa-book"></i> Disciplina
                        </label>
                        <input type="text" id="filtroDisciplina" class="filtro-input"
                            placeholder="Digite o nome da disciplina">
                    </div>

                    <!-- Filtro por Curso (AGORA √â SELECT) -->
                    <div class="filtro-group">
                        <label for="filtroCurso" class="filtro-label">
                            <i class="fas fa-graduation-cap"></i> Curso
                        </label>
                        <select id="filtroCurso" class="filtro-select">
                            <option value="">Todos os cursos</option>
                            <!-- Os cursos ser√£o carregados via JavaScript -->
                        </select>
                    </div>

                    <!-- Filtro por Professor -->
                    <div class="filtro-group">
                        <label for="filtroProfessor" class="filtro-label">
                            <i class="fas fa-chalkboard-teacher"></i> Professor
                        </label>
                        <select id="filtroProfessor" class="filtro-select">
                            <option value="">Todos os professores</option>
                            <!-- Os professores ser√£o carregados via JavaScript -->
                        </select>
                    </div>

                    <!-- Filtro por Turma -->
                    <div class="filtro-group">
                        <label for="filtroTurma" class="filtro-label">
                            <i class="fas fa-users"></i> Turma
                        </label>
                        <input type="text" id="filtroTurma" class="filtro-input" placeholder="Digite a turma">
                    </div>

                    <!-- Filtro por Sala -->
                    <div class="filtro-group">
                        <label for="filtroSala" class="filtro-label">
                            <i class="fas fa-door-open"></i> Sala
                        </label>
                        <input type="text" id="filtroSala" class="filtro-input" placeholder="N√∫mero ou bloco da sala">
                    </div>

                    <!-- Filtro por Dia da Semana -->
                    <div class="filtro-group">
                        <label for="filtroDia" class="filtro-label">
                            <i class="fas fa-calendar-day"></i> Dia da Semana
                        </label>
                        <select id="filtroDia" class="filtro-select">
                            <option value="">Todos os dias</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Ter√ßa-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                        </select>
                    </div>

                    <!-- Filtro por Status -->
                    <div class="filtro-group">
                        <label for="filtroStatus" class="filtro-label">
                            <i class="fas fa-info-circle"></i> Status
                        </label>
                        <select id="filtroStatus" class="filtro-select">
                            <option value="">Todos os status</option>
                            <option value="ativa">Aulas Ativas</option>
                            <option value="cancelada">Aulas Canceladas</option>
                        </select>
                    </div>
                </div>

                <div class="filtros-actions">
                    <button type="button" id="btnLimparFiltros" class="btn-filtro btn-limpar">
                        <i class="fas fa-times"></i> Limpar Filtros
                    </button>
                </div>
            </div>

            <div class="professor-aulas-grid" id="aulas-professor-grid">
                <div class="professor-empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando suas aulas...</p>
                </div>
            </div>
        </section>

        <!-- ==================== SE√á√ÉO: CRIAR AULA ==================== -->
        <section id="criar-aula" class="section">
            <div class="professor-page-header">
                <h2><i class="fas fa-plus-circle"></i> Criar Nova Aula</h2>
                <button class="btn-voltar" onclick="showSection('minhas-aulas-professor')">
                    <i class="fas fa-arrow-left"></i> Voltar para Aulas
                </button>
            </div>

            <div class="professor-form-container">
                <form class="professor-criar-aula-form" id="formCriarAula">
                    <div class="professor-form-row">
                        <div class="professor-form-group">
                            <label for="cursoSelect" class="professor-form-label">
                                <i class="fas fa-graduation-cap"></i> Curso *
                            </label>
                            <select id="cursoSelect" class="professor-form-control select-habilitado" required>
                                <option value="">Selecione o curso</option>
                            </select>
                        </div>
                        <div class="professor-form-group">
                            <label for="periodoSelect" class="professor-form-label">
                                <i class="fas fa-calendar-alt"></i> Per√≠odo *
                            </label>
                            <select id="periodoSelect" class="professor-form-control select-desabilitado" required
                                disabled>
                                <option value="">Primeiro selecione o curso</option>
                            </select>
                        </div>
                    </div>

                    <div class="professor-form-row">
                        <div class="professor-form-group">
                            <label for="turmaSelect" class="professor-form-label">
                                <i class="fas fa-users"></i> Turma *
                            </label>
                            <select id="turmaSelect" class="professor-form-control select-desabilitado" required
                                disabled>
                                <option value="">Primeiro selecione o curso e per√≠odo</option>
                            </select>
                        </div>
                        <div class="professor-form-group">
                            <label for="disciplinaInput" class="professor-form-label">
                                <i class="fas fa-book"></i> Disciplina *
                            </label>
                            <input type="text" id="disciplinaInput" class="professor-form-control" required
                                placeholder="Ex: Programa√ß√£o Web, C√°lculo I, Direito Civil...">
                            <small class="professor-form-help">Nome completo da disciplina</small>
                        </div>
                    </div>

                    <div class="professor-form-row">
                        <div class="professor-form-group professor-form-group-full">
                            <label for="searchSala" class="professor-form-label">
                                <i class="fas fa-door-open"></i> Buscar Sala *
                            </label>
                            <div class="professor-search-container">
                                <input type="text" id="searchSala" class="professor-search-input"
                                    placeholder="Digite para filtrar salas... (Ex: A101, Laborat√≥rio, Bloco B)">
                                <i class="fas fa-search professor-search-icon"></i>
                            </div>

                            <label for="salaSelect" class="professor-form-label sala-select-label">
                                <i class="fas fa-list"></i> Selecione a Sala *
                            </label>
                            <select id="salaSelect" class="professor-form-control professor-sala-select" required
                                size="6">
                                <option value="">Selecione uma sala da lista abaixo</option>
                            </select>
                            <small class="professor-form-help">Use a busca acima para filtrar as salas</small>
                        </div>
                    </div>

                    <div class="professor-form-row">
                        <div class="professor-form-group">
                            <label for="horarioSelect" class="professor-form-label">
                                <i class="fas fa-clock"></i> Hor√°rio *
                            </label>
                            <select id="horarioSelect" class="professor-form-control" required>
                                <option value="">Selecione o hor√°rio</option>
                                <option value="18:50-19:40">18:50 - 19:40</option>
                                <option value="19:40-20:30">19:40 - 20:30</option>
                                <option value="20:40-21:30">20:40 - 21:30</option>
                                <option value="21:30-22:20">21:30 - 22:20</option>
                            </select>
                        </div>
                    </div>

                    <div class="professor-form-group professor-dias-container">
                        <label class="professor-form-label">
                            <i class="fas fa-calendar-day"></i> Dias da Semana *
                        </label>
                        <div class="professor-dias-checkbox">
                            <label class="professor-checkbox-label">
                                <input type="checkbox" name="dias" value="segunda">
                                <span class="professor-checkmark"></span>
                                <span class="professor-dia-text">Segunda</span>
                            </label>
                            <label class="professor-checkbox-label">
                                <input type="checkbox" name="dias" value="terca">
                                <span class="professor-checkmark"></span>
                                <span class="professor-dia-text">Ter√ßa</span>
                            </label>
                            <label class="professor-checkbox-label">
                                <input type="checkbox" name="dias" value="quarta">
                                <span class="professor-checkmark"></span>
                                <span class="professor-dia-text">Quarta</span>
                            </label>
                            <label class="professor-checkbox-label">
                                <input type="checkbox" name="dias" value="quinta">
                                <span class="professor-checkmark"></span>
                                <span class="professor-dia-text">Quinta</span>
                            </label>
                            <label class="professor-checkbox-label">
                                <input type="checkbox" name="dias" value="sexta">
                                <span class="professor-checkmark"></span>
                                <span class="professor-dia-text">Sexta</span>
                            </label>
                        </div>
                        <small class="professor-form-help">Selecione os dias em que a aula ocorrer√°</small>
                    </div>

                    <div class="professor-form-actions">
                        <button type="submit" class="btn-primary professor-btn-large">
                            <i class="fas fa-save"></i> Criar Aula
                        </button>
                        <button type="button" class="professor-btn-secondary"
                            onclick="showSection('minhas-aulas-professor')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>

                    <div class="professor-form-info">
                        <p><i class="fas fa-info-circle"></i> Todos os campos marcados com * s√£o obrigat√≥rios</p>
                    </div>
                </form>
            </div>

            <!-- ==================== PAINEL DE DEBUG ==================== -->
            <div class="debug-panel"
                style="margin-top: 30px; padding: 20px; background: #fff3cd; border: 2px dashed #ffc107; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0; color: #856404;">
                    <i class="fas fa-bug"></i> Painel de Debug (Remover em Produ√ß√£o)
                </h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" onclick="debugForm()" class="btn" style="background: #17a2b8; color: white;">
                        <i class="fas fa-info-circle"></i> Verificar Estado
                    </button>
                    <button type="button" onclick="debugSections()" class="btn"
                        style="background: #6c757d; color: white;">
                        <i class="fas fa-layer-group"></i> Ver Sections
                    </button>
                    <button type="button" onclick="debugCursoPeriodo()" class="btn"
                        style="background: #28a745; color: white;">
                        <i class="fas fa-play"></i> Testar Curso/Per√≠odo
                    </button>
                    <button type="button" onclick="testarHabilitarPeriodo()" class="btn"
                        style="background: #e83e8c; color: white;">
                        <i class="fas fa-magic"></i> Testar Per√≠odo
                    </button>
                    <button type="button" onclick="professorManager.debugCriarAula()" class="btn"
                        style="background: #dc3545; color: white;">
                        <i class="fas fa-bolt"></i> Teste Manual API
                    </button>
                </div>
                <div id="debug-output"
                    style="margin-top: 15px; padding: 10px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                    <!-- Output do debug aparecer√° aqui -->
                </div>
            </div>
        </section>

        <!-- ==================== SE√á√ÉO: MAPA DE SALAS ==================== -->
        <section id="mapa-blocos" class="section">
            <div class="professor-page-header">
                <h2><i class="fas fa-door-open"></i> Mapa de Salas</h2>
                <button class="btn-voltar" onclick="showSection('minhas-aulas-professor')">
                    <i class="fas fa-arrow-left"></i> Voltar para Minhas Aulas
                </button>
            </div>

            <div class="professor-blocos-grid" id="blocos-grid">
                <div class="professor-empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando blocos...</p>
                </div>
            </div>

            <div id="andares-section" class="andares-section" style="display: none;">
                <div class="professor-andares-header">
                    <button class="professor-btn-voltar-andar" onclick="voltarParaBlocos()">
                        <i class="fas fa-arrow-left"></i> Voltar para Blocos
                    </button>
                    <h3 id="bloco-selecionado-title">Bloco </h3>
                </div>

                <div class="professor-andares-grid" id="andares-grid">
                </div>
            </div>

            <div id="salas-section" class="salas-section" style="display: none;">
                <div class="professor-salas-header">
                    <button class="professor-btn-voltar-sala" onclick="voltarParaAndares()">
                        <i class="fas fa-arrow-left"></i> Voltar para Andares
                    </button>
                    <h3 id="andar-selecionado-title">Andar </h3>
                </div>

                <div class="professor-salas-filters">
                    <div class="professor-filter-group">
                        <input type="text" id="searchSalaMapa" class="professor-search-input"
                            placeholder="Pesquisar sala...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="professor-filter-group">
                        <select id="filterTipoSala" class="professor-filter-select">
                            <option value="">Todos os tipos</option>
                            <option value="aula">Sala de Aula</option>
                            <option value="laboratorio">Laborat√≥rio</option>
                            <option value="auditorio">Audit√≥rio</option>
                        </select>
                    </div>
                </div>

                <div class="professor-salas-grid" id="salas-grid">
                </div>
            </div>
        </section>
    </main>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/professor.js"></script>
    <script src="js/professores.js"></script>
    <script src="js/professor-mapa.js"></script>

    <script>
        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let blocosData = [];
        let currentBloco = null;
        let currentAndar = null;

        // ==================== FUN√á√ïES DE NAVEGA√á√ÉO E UI ====================
        function toggleMenu() {
            const nav = document.getElementById('mobileNav');
            nav.classList.toggle('active');
        }

        function closeMenu() {
            const nav = document.getElementById('mobileNav');
            nav.classList.remove('active');
        }

        function showSection(sectionId) {
            closeMenu();

            // Atualizar navega√ß√£o ativa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            document.querySelectorAll('.mobile-nav a').forEach(link => {
                link.classList.remove('active');
            });

            const clickedDesktopLink = document.querySelector(`.desktop-nav [onclick="showSection('${sectionId}')"]`);
            if (clickedDesktopLink) {
                clickedDesktopLink.classList.add('active');
            }

            const clickedMobileLink = document.querySelector(`.mobile-nav [onclick="showSection('${sectionId}')"]`);
            if (clickedMobileLink) {
                clickedMobileLink.classList.add('active');
            }

            // Mostrar se√ß√£o
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');

                // Configurar formul√°rio quando a se√ß√£o de criar aula for aberta
                if (sectionId === 'criar-aula') {
                    console.log('üéØ Se√ß√£o criar-aula aberta, configurando formul√°rio...');
                    setTimeout(() => {
                        configurarFormularioAula();
                        professorManager.carregarSalasDisponiveis();
                    }, 200);
                }
            }

            window.scrollTo(0, 0);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ==================== FUN√á√ïES DE INTERFACE DO USU√ÅRIO ====================
        function atualizarInterfaceUsuario() {
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);

                    console.log('üë§ Atualizando interface para usu√°rio:', user);

                    // Atualizar desktop
                    const desktopUser = document.getElementById('desktopUserName');
                    if (desktopUser) {
                        desktopUser.innerHTML = `
                            <i class="fas fa-user"></i> ${user.nome} 
                            <span class="user-type-badge professor" style="
                                background: #3498db;
                                color: white;
                                padding: 2px 8px;
                                border-radius: 12px;
                                font-size: 0.7rem;
                                margin-left: 8px;
                                font-weight: 600;
                            ">PROFESSOR</span>
                        `;
                    }

                    // Atualizar mobile
                    const mobileUser = document.getElementById('mobileUserName');
                    if (mobileUser) {
                        mobileUser.innerHTML = `${user.nome} <span style="
                            background: #3498db; 
                            color: white; 
                            padding: 2px 6px; 
                            border-radius: 10px; 
                            font-size: 0.6rem; 
                            margin-left: 5px;
                        ">PROF</span>`;
                    }

                    // Atualizar navega√ß√£o mobile
                    const navUser = document.getElementById('mobileNavUser');
                    if (navUser) {
                        navUser.innerHTML = `<i class="fas fa-chalkboard-teacher"></i> ${user.nome} <span style="
                            background: #3498db; 
                            color: white; 
                            padding: 2px 6px; 
                            border-radius: 10px; 
                            font-size: 0.6rem; 
                            margin-left: 5px;
                        ">PROF</span>`;
                    }

                } catch (error) {
                    console.error('‚ùå Erro ao carregar usu√°rio:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Nenhum usu√°rio encontrado no localStorage');
            }
        }

        // ==================== INICIALIZA√á√ÉO DO DASHBOARD ====================
        function initializeProfessorDashboard() {
            console.log('üéØ Inicializando dashboard do professor...');

            const user = authManager.getCurrentUser();

            if (!user || user.tipo !== 'professor') {
                alert('Acesso restrito para professores!');
                window.location.href = 'login.html';
                return;
            }

            console.log('üë§ Professor carregado:', user);

            atualizarInterfaceUsuario();
            configurarFormularioAula();
            inicializarMapaProfessor();
        }

        // ==================== CONFIGURA√á√ÉO DO FORMUL√ÅRIO ====================
        // ==================== CONFIGURA√á√ÉO DO FORMUL√ÅRIO ====================
        let formSubmitHandler = null;

        function configurarFormularioAula() {
            const formCriarAula = document.getElementById('formCriarAula');
            console.log('üîç Procurando formul√°rio:', formCriarAula);

            if (formCriarAula) {
                console.log('‚úÖ Formul√°rio encontrado, configurando evento submit...');

                // üî• CORRE√á√ÉO: Remover event listener anterior se existir
                if (formSubmitHandler) {
                    formCriarAula.removeEventListener('submit', formSubmitHandler);
                }

                // üî• CORRE√á√ÉO: Criar handler √∫nico e reutiliz√°vel
                formSubmitHandler = async function (e) {
                    console.log('üéØ EVENTO SUBMIT DISPARADO!');
                    e.preventDefault();
                    e.stopImmediatePropagation(); // üî• Impede m√∫ltiplas execu√ß√µes

                    const submitBtn = e.target.querySelector('button[type="submit"]');

                    // üî• CORRE√á√ÉO: Prevenir duplo clique
                    if (submitBtn.disabled) {
                        console.log('‚ö†Ô∏è Bot√£o j√° est√° processando, ignorando clique...');
                        return;
                    }

                    try {
                        await handleFormSubmit(e);
                    } catch (error) {
                        console.error('‚ùå Erro no evento submit:', error);
                        showNotification('Erro ao processar formul√°rio: ' + error.message, 'error');

                        // Reativar bot√£o em caso de erro
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Criar Aula';
                    }
                };

                formCriarAula.addEventListener('submit', formSubmitHandler);
                console.log('‚úÖ Evento submit configurado com sucesso!');
            } else {
                console.error('‚ùå Formul√°rio n√£o encontrado!');
            }

            // Configurar busca de salas (mantido igual)
            const searchInput = document.getElementById('searchSala');
            const salaSelect = document.getElementById('salaSelect');

            if (searchInput && salaSelect) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const options = salaSelect.getElementsByTagName('option');

                    for (let i = 0; i < options.length; i++) {
                        const text = options[i].textContent.toLowerCase();
                        options[i].style.display = text.includes(searchTerm) ? '' : 'none';
                    }

                    if (options[0]) options[0].style.display = '';
                });
            }
        }

        // üî• CORRE√á√ÉO: Fun√ß√£o separada para lidar com o submit do formul√°rio
        async function handleFormSubmit(e) {
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');

            // Coletar dados do formul√°rio
            const dadosAula = {
                disciplina: document.getElementById('disciplinaInput').value.trim(),
                sala_id: document.getElementById('salaSelect').value,
                curso: document.getElementById('cursoSelect').value,
                turma: document.getElementById('turmaSelect').value,
                horario: document.getElementById('horarioSelect').value
            };

            console.log('üìã Dados coletados do formul√°rio:', dadosAula);

            // Valida√ß√£o b√°sica
            if (!dadosAula.curso) {
                showNotification('‚ùå Selecione um curso', 'error');
                return;
            }
            if (!dadosAula.turma) {
                showNotification('‚ùå Selecione uma turma', 'error');
                return;
            }
            if (!dadosAula.sala_id) {
                showNotification('‚ùå Selecione uma sala', 'error');
                return;
            }
            if (!dadosAula.disciplina) {
                showNotification('‚ùå Digite o nome da disciplina', 'error');
                return;
            }
            if (!dadosAula.horario) {
                showNotification('‚ùå Selecione um hor√°rio', 'error');
                return;
            }

            // Validar dias da semana
            const diasSelecionados = Array.from(document.querySelectorAll('input[name="dias"]:checked'))
                .map(cb => cb.value);

            console.log('üìÖ Dias selecionados:', diasSelecionados);
            if (diasSelecionados.length === 0) {
                showNotification('‚ùå Selecione pelo menos um dia da semana', 'error');
                return;
            }

            // Processar hor√°rio
            if (dadosAula.horario) {
                const [horario_inicio, horario_fim] = dadosAula.horario.split('-');
                dadosAula.horario_inicio = horario_inicio.trim();
                dadosAula.horario_fim = horario_fim.trim();
                delete dadosAula.horario;
            }

            console.log('üöÄ Chamando professorManager.criarAula...');

            // Mostrar loading
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando Aula...';
            submitBtn.disabled = true;

            try {
                // üî• CORRE√á√ÉO: Passar os dias selecionados para o m√©todo criarAula
                await professorManager.criarAula(dadosAula, diasSelecionados);
            } finally {
                // Restaurar bot√£o
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================== FUN√á√ïES DO MAPA ====================
        function inicializarMapaProfessor() {
            console.log('üó∫Ô∏è Inicializando mapa do professor...');
            carregarBlocos();
            configurarEventosMapa();
        }

        async function carregarBlocos() {
            try {
                console.log('üì° Carregando blocos da API...');

                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/salas/blocos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    blocosData = await response.json();
                    console.log('‚úÖ Blocos carregados:', blocosData);
                    renderizarBlocos(blocosData);
                } else {
                    throw new Error('Erro ao carregar blocos');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar blocos:', error);
                usarBlocosPadrao();
            }
        }

        function renderizarBlocos(blocos) {
            const container = document.getElementById('blocos-grid');
            if (!container) return;

            if (!blocos || blocos.length === 0) {
                container.innerHTML = `
                    <div class="professor-empty-state">
                        <i class="fas fa-building fa-3x"></i>
                        <p>Nenhum bloco encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = blocos.map(bloco => `
                <div class="professor-bloco-card" data-bloco="${bloco.letra}" onclick="selecionarBloco('${bloco.letra}')">
                    <div class="professor-bloco-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3>Bloco ${bloco.letra}</h3>
                    <div class="professor-bloco-stats">
                        <span class="professor-stat">${bloco.total_salas} salas</span>
                        <span class="professor-stat">${bloco.total_andares} andares</span>
                    </div>
                    <div class="professor-bloco-badge">
                        ${bloco.total_salas} salas
                    </div>
                </div>
            `).join('');

            console.log(`‚úÖ ${blocos.length} blocos renderizados`);
        }

        function usarBlocosPadrao() {
            console.log('üîÑ Usando blocos padr√£o...');
            const blocosPadrao = [
                { letra: 'A', total_salas: 58, total_andares: 4 },
                { letra: 'B', total_salas: 46, total_andares: 4 },
                { letra: 'C', total_salas: 45, total_andares: 4 },
                { letra: 'D', total_salas: 48, total_andares: 4 },
                { letra: 'E', total_salas: 84, total_andares: 4 },
                { letra: 'F', total_salas: 87, total_andares: 4 },
                { letra: 'G', total_salas: 87, total_andares: 4 },
                { letra: 'H', total_salas: 81, total_andares: 4 },
                { letra: 'I', total_salas: 82, total_andares: 4 },
                { letra: 'J', total_salas: 82, total_andares: 4 },
                { letra: 'K', total_salas: 82, total_andares: 4 },
                { letra: 'L', total_salas: 79, total_andares: 4 },
                { letra: 'M', total_salas: 84, total_andares: 4 },
                { letra: 'N', total_salas: 83, total_andares: 4 }
            ];
            renderizarBlocos(blocosPadrao);
        }

        async function selecionarBloco(bloco) {
            console.log(`üè¢ Selecionando bloco: ${bloco}`);
            currentBloco = bloco;

            document.getElementById('bloco-selecionado-title').textContent = `Bloco ${bloco}`;

            document.getElementById('andares-grid').innerHTML = `
                <div class="professor-empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando andares...</p>
                </div>
            `;

            document.getElementById('blocos-grid').style.display = 'none';
            document.getElementById('andares-section').style.display = 'block';
            document.getElementById('salas-section').style.display = 'none';

            await carregarAndares(bloco);
        }

        async function carregarAndares(bloco) {
            try {
                console.log(`üì° Carregando andares do bloco ${bloco}...`);

                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/salas/bloco/${bloco}/andares`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const andares = await response.json();
                    console.log(`‚úÖ Andares carregados:`, andares);
                    renderizarAndares(andares);
                } else {
                    throw new Error('Erro ao carregar andares');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar andares:', error);
                usarAndaresPadrao();
            }
        }

        function renderizarAndares(andares) {
            const container = document.getElementById('andares-grid');
            if (!container) return;

            if (!andares || andares.length === 0) {
                container.innerHTML = `
                    <div class="professor-empty-state">
                        <i class="fas fa-door-closed fa-3x"></i>
                        <p>Nenhum andar encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = andares.map(andar => `
                <div class="professor-andar-card" onclick="selecionarAndar('${andar}')">
                    <div class="professor-andar-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h4>${andar}</h4>
                    <p>Clique para ver as salas</p>
                </div>
            `).join('');

            console.log(`‚úÖ ${andares.length} andares renderizados`);
        }

        function usarAndaresPadrao() {
            const andaresPadrao = ['T√©rreo', '1¬∫ Andar', '2¬∫ Andar', '3¬∫ Andar'];
            renderizarAndares(andaresPadrao);
        }

        async function selecionarAndar(andar) {
            console.log(`üö™ Selecionando andar: ${andar} do bloco ${currentBloco}`);
            currentAndar = andar;

            document.getElementById('andar-selecionado-title').textContent = `Bloco ${currentBloco} > ${andar}`;

            document.getElementById('salas-grid').innerHTML = `
                <div class="professor-empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando salas...</p>
                </div>
            `;

            document.getElementById('andares-section').style.display = 'none';
            document.getElementById('salas-section').style.display = 'block';

            await carregarSalas(currentBloco, andar);
        }

        async function carregarSalas(bloco, andar) {
            try {
                console.log(`üì° Carregando salas: Bloco ${bloco}, Andar ${andar}`);

                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/salas/bloco/${bloco}/andar/${andar}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const salas = await response.json();
                    console.log(`‚úÖ ${salas.length} salas carregadas`);
                    renderizarSalas(salas);
                } else {
                    throw new Error('Erro ao carregar salas');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar salas:', error);
                document.getElementById('salas-grid').innerHTML = `
                    <div class="professor-empty-state">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <p>Erro ao carregar salas</p>
                        <p class="empty-subtitle">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderizarSalas(salas) {
            const container = document.getElementById('salas-grid');
            if (!container) return;

            if (!salas || salas.length === 0) {
                container.innerHTML = `
                    <div class="professor-empty-state">
                        <i class="fas fa-door-closed fa-3x"></i>
                        <p>Nenhuma sala encontrada</p>
                        <p class="empty-subtitle">Bloco ${currentBloco}, ${currentAndar}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = salas.map(sala => `
                <div class="professor-sala-card">
                    <div class="professor-sala-header">
                        <h4>Sala ${sala.numero}</h4>
                        <span class="professor-sala-status disponivel">üü¢ Dispon√≠vel</span>
                    </div>
                    <div class="professor-sala-info">
                        <p><strong>Tipo:</strong> ${sala.tipo}</p>
                        <p><strong>Capacidade:</strong> ${sala.capacidade} pessoas</p>
                        ${sala.recursos ? `<p><strong>Recursos:</strong> ${sala.recursos}</p>` : ''}
                        ${sala.telefone ? `<p><strong>Telefone:</strong> ${sala.telefone}</p>` : ''}
                        ${sala.email ? `<p><strong>Email:</strong> ${sala.email}</p>` : ''}
                    </div>
                    <div class="professor-sala-actions">
                        <button class="professor-btn-action small" onclick="verDetalhesSala(${sala.id})">
                            <i class="fas fa-info-circle"></i> Detalhes
                        </button>
                    </div>
                </div>
            `).join('');

            console.log(`‚úÖ ${salas.length} salas renderizadas`);
        }

        function voltarParaBlocos() {
            document.getElementById('andares-section').style.display = 'none';
            document.getElementById('salas-section').style.display = 'none';
            document.getElementById('blocos-grid').style.display = 'grid';
            currentBloco = null;
        }

        function voltarParaAndares() {
            document.getElementById('salas-section').style.display = 'none';
            document.getElementById('andares-section').style.display = 'block';
            currentAndar = null;
        }

        function configurarEventosMapa() {
            const searchInput = document.getElementById('searchSalaMapa');
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    filtrarSalas(this.value);
                });
            }

            const tipoFilter = document.getElementById('filterTipoSala');
            if (tipoFilter) {
                tipoFilter.addEventListener('change', function () {
                    filtrarSalasPorTipo(this.value);
                });
            }
        }

        function filtrarSalas(termo) {
            const salas = document.querySelectorAll('.professor-sala-card');
            const termoLower = termo.toLowerCase();

            salas.forEach(sala => {
                const texto = sala.textContent.toLowerCase();
                sala.style.display = texto.includes(termoLower) ? 'block' : 'none';
            });
        }

        function filtrarSalasPorTipo(tipo) {
            const salas = document.querySelectorAll('.professor-sala-card');

            salas.forEach(sala => {
                if (!tipo) {
                    sala.style.display = 'block';
                    return;
                }

                const tipoTexto = sala.querySelector('p:nth-child(1)').textContent.toLowerCase();
                sala.style.display = tipoTexto.includes(tipo.toLowerCase()) ? 'block' : 'none';
            });
        }

        function verDetalhesSala(salaId) {
            alert(`Detalhes da sala ${salaId}\n\nEm desenvolvimento...`);
        }

        // ==================== FUN√á√ïES DE DEBUG ====================
        function debugSections() {
            console.log('üîç DEBUG SECTIONS:');

            document.querySelectorAll('.section').forEach(section => {
                console.log(`--- ${section.id} ---`);
                console.log('- display:', window.getComputedStyle(section).display);
                console.log('- active:', section.classList.contains('active'));
                console.log('- formCriarAula:', section.querySelector('#formCriarAula') ? '‚úÖ ENCONTRADO' : '‚ùå N√ÉO ENCONTRADO');

                // Mostrar todo o HTML interno da section
                if (section.id === 'criar-aula') {
                    console.log('- HTML:', section.innerHTML.substring(0, 500) + '...');
                }
            });
        }

        function debugForm() {
            console.log('üîç DEBUG FORMUL√ÅRIO:');
            console.log('- formCriarAula:', document.getElementById('formCriarAula'));
            console.log('- bot√£o submit:', document.querySelector('#formCriarAula button[type="submit"]'));
            console.log('- professorManager:', typeof professorManager);
            console.log('- criarAula:', typeof professorManager?.criarAula);
        }

        function debugCursoPeriodo() {
            console.log('üéì DEBUG CURSO/PER√çODO:');

            const cursoSelect = document.getElementById('cursoSelect');
            const periodoSelect = document.getElementById('periodoSelect');

            console.log('üìä Curso Select:');
            console.log('- Elemento:', cursoSelect);
            console.log('- Valor:', cursoSelect?.value);
            console.log('- Disabled:', cursoSelect?.disabled);
            console.log('- Options:', cursoSelect?.options?.length);

            console.log('üìä Per√≠odo Select:');
            console.log('- Elemento:', periodoSelect);
            console.log('- Valor:', periodoSelect?.value);
            console.log('- Disabled:', periodoSelect?.disabled);
            console.log('- Classes:', periodoSelect?.className);
        }

        function testarHabilitarPeriodo() {
            console.log('üß™ TESTE MANUAL: Habilitar Per√≠odo');

            const periodoSelect = document.getElementById('periodoSelect');
            if (!periodoSelect) {
                console.error('‚ùå periodoSelect n√£o encontrado');
                return;
            }

            console.log('üìä Estado atual do per√≠odo:');
            console.log('- disabled:', periodoSelect.disabled);
            console.log('- classes:', periodoSelect.className);

            // Habilitar manualmente
            periodoSelect.disabled = false;
            periodoSelect.classList.remove('select-desabilitado');
            periodoSelect.classList.add('select-habilitado');
            periodoSelect.style.opacity = '1';
            periodoSelect.style.cursor = 'pointer';
            periodoSelect.style.backgroundColor = '';

            console.log('üìä Estado ap√≥s habilitar manualmente:');
            console.log('- disabled:', periodoSelect.disabled);
            console.log('- classes:', periodoSelect.className);

            // Popular com alguns per√≠odos de exemplo
            periodoSelect.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Selecione o per√≠odo (TESTE)';
            periodoSelect.appendChild(placeholder);

            for (let i = 1; i <= 8; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}¬∞ Per√≠odo (TESTE)`;
                periodoSelect.appendChild(option);
            }

            console.log('‚úÖ Per√≠odo habilitado manualmente para teste');
        }

        function debugLog(mensagem) {
            const output = document.getElementById('debug-output');
            if (output) {
                output.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${mensagem}</div>`;
                output.scrollTop = output.scrollHeight;
            }
            console.log(mensagem);
        }

        // ==================== EVENT LISTENERS GLOBAIS ====================
        document.addEventListener('click', function (event) {
            const nav = document.getElementById('mobileNav');
            const hamburger = document.querySelector('.menu-hamburger');

            if (nav.classList.contains('active') &&
                !nav.contains(event.target) &&
                !hamburger.contains(event.target)) {
                nav.classList.remove('active');
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìÑ DOM carregado - Inicializando dashboard do professor...');

            setTimeout(() => {
                atualizarInterfaceUsuario();
                initializeProfessorDashboard();

                console.log('‚úÖ Inicializa√ß√£o completa');
                console.log('üìä Estado inicial:');
                console.log('- professorManager:', typeof professorManager);
                console.log('- formCriarAula:', document.getElementById('formCriarAula'));

            }, 500);
        });

        // ==================== EXPORTA√á√ÉO PARA CONSOLE ====================
        window.debugForm = debugForm;
        window.debugSections = debugSections;
        window.debugCursoPeriodo = debugCursoPeriodo;
        window.testarHabilitarPeriodo = testarHabilitarPeriodo;
        window.debugLog = debugLog;
        window.debugMapaProfessor = function () {
            console.log('üîç DEBUG MAPA PROFESSOR:');
            console.log('- Blocos carregados:', blocosData.length);
            console.log('- Bloco atual:', currentBloco);
            console.log('- Andar atual:', currentAndar);
            console.log('- Token presente:', !!localStorage.getItem('authToken'));
            console.log('- User data:', localStorage.getItem('userData'));
        };
    </script>
</body>

</html>