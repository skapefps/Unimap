<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMAP - Cadastre-se</title>
    <link rel="stylesheet" href="css/cadastro.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="shortcut icon" type="imagex/png" href="../frontend/images/logo-unipam 2.png">
</head>
<body>
    <div class="register-container">
        <!-- Desktop View -->
        <div class="desktop-view">
            <form class="register-form" id="registerFormDesktop">
                <div class="form-logo">
                    <img src="images/logo-unipam.png" alt="UNIMAP Logo">
                </div>
                
                <div class="form-title">Criar Conta</div>
                
                <div id="registerErrorDesktop" class="error-message"></div>
                
                <div class="input-group">
                    <input type="text" id="fullNameDesktop" placeholder="Nome Completo" required>
                </div>
                
                <div class="input-group">
                    <input type="email" id="emailDesktop" placeholder="E-mail" required>
                </div>
                
                <div class="input-group">
                    <input type="text" id="usernameDesktop" placeholder="Usuario" required>
                </div>
                
                <div class="input-group">
                    <input type="password" id="passwordDesktop" placeholder="Senha" required>
                </div>
                
                <div class="input-group">
                    <input type="password" id="confirmPasswordDesktop" placeholder="Confirmar senha" required>
                </div>
                
                <button type="button" class="btn-primary" id="registerBtnDesktop">Cadastrar</button>
                
                <div class="divider">
                    <span>OU</span>
                </div>
                
                <button type="button" class="btn-secondary" onclick="window.location.href='login.html'">
                    Fazer Login
                </button>
            </form>
        </div>

        <!-- Mobile View -->
        <div class="mobile-view">
            <form class="mobile-register-form" id="registerFormMobile">
                <div class="form-logo">
                    <img src="images/logo-unipam.png" alt="UNIMAP Logo">
                </div>
                
                <div class="mobile-form-title">Criar Conta</div>
                
                <div id="registerErrorMobile" class="error-message"></div>
                
                <div class="mobile-input-group">
                    <input type="text" id="fullNameMobile" placeholder="Nome Completo" required>
                </div>
                
                <div class="mobile-input-group">
                    <input type="email" id="emailMobile" placeholder="E-mail" required>
                </div>
                
                <div class="mobile-input-group">
                    <input type="text" id="usernameMobile" placeholder="Usuario" required>
                </div>
                
                <div class="mobile-input-group">
                    <input type="password" id="passwordMobile" placeholder="Senha" required>
                </div>
                
                <div class="mobile-input-group">
                    <input type="password" id="confirmPasswordMobile" placeholder="Confirmar senha" required>
                </div>
                
                <button type="button" class="mobile-btn-primary" id="registerBtnMobile">Cadastrar</button>
                
                <div class="mobile-divider">
                    <span>OU</span>
                </div>
                
                
                <button type="button" class="mobile-btn-secondary" onclick="window.location.href='login.html'">
                    Fazer Login
                </button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
<script>
    let isProcessing = false;
    
    // CSS para mensagens - COLOCAR NO IN√çCIO
    const style = document.createElement('style');
    style.textContent = `
        .custom-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            width: 90%;
            max-width: 500px;
            box-sizing: border-box;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 16px;
            animation: slideIn 0.5s ease;
        }
        
        .custom-message-success {
            background: #4CAF50;
            color: white;
            border: 1px solid #45a049;
        }
        
        .custom-message-error {
            background: #f44336;
            color: white;
            border: 1px solid #d32f2f;
        }
        
        .custom-message-warning {
            background: #ff9800;
            color: white;
            border: 1px solid #f57c00;
        }
        
        .custom-message-info {
            background: #2196F3;
            color: white;
            border: 1px solid #1976D2;
        }
        
        .custom-message button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            margin-left: 15px;
            padding: 0;
            color: inherit;
            font-weight: bold;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(-50%) translateY(-50px); 
                opacity: 0; 
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
            }
            to { 
                transform: translateX(-50%) translateY(-50px); 
                opacity: 0; 
            }
        }
    `;
    document.head.appendChild(style);
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('UNIMAP Cadastro carregado');
        setupOurForms();
        
        // Prevenir submit dos formul√°rios
        document.getElementById('registerFormDesktop').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Submit prevenido - desktop');
        });
        
        document.getElementById('registerFormMobile').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Submit prevenido - mobile');
        });
    });

    function setupOurForms() {
        console.log('üîß Configurando formul√°rios...');
        
        // Desktop
        const desktopBtn = document.getElementById('registerBtnDesktop');
        if (desktopBtn) {
            desktopBtn.onclick = function(e) {
                console.log('üéØ Cadastro desktop iniciado');
                handleRegister('desktop');
            };
        }
        
        // Mobile
        const mobileBtn = document.getElementById('registerBtnMobile');
        if (mobileBtn) {
            mobileBtn.onclick = function(e) {
                console.log('üéØ Cadastro mobile iniciado');
                handleRegister('mobile');
            };
        }
        
        console.log('‚úÖ Formul√°rios configurados!');
    }

    async function handleRegister(version = 'desktop') {
        if (isProcessing) {
            console.log('‚è≥ Cadastro j√° em processamento...');
            return;
        }
        
        isProcessing = true;
        console.log('üéØ INICIANDO CADASTRO...');
        
        const inputs = getFormInputs(version);
        const registerBtn = version === 'mobile' 
            ? document.getElementById('registerBtnMobile')
            : document.getElementById('registerBtnDesktop');

        // Validar dados
        const validation = validateData(inputs);
        if (!validation.isValid) {
            showMessage('‚ùå ' + validation.message, 'error', 4000);
            isProcessing = false;
            return;
        }

        // Mostrar loading
        if (registerBtn) {
            registerBtn.textContent = 'üîÑ CADASTRANDO...';
            registerBtn.disabled = true;
            registerBtn.style.opacity = '0.7';
        }

        try {
            const userData = {
                nome: inputs.fullName.value.trim(),
                email: inputs.email.value.trim(),
                matricula: inputs.username.value.trim(),
                senha: inputs.password.value
            };

            console.log('üì§ Enviando dados:', userData);
            const result = await api.register(userData);
            
            if (result.success) {
                console.log('‚úÖ Cadastro realizado com sucesso!');
                
                // MOSTRAR MENSAGEM POR MAIS TEMPO
                showMessage('‚úÖ ' + result.message + ' Redirecionando para login...', 'success', 3000);
                
                // Limpar formul√°rio
                clearForm(inputs);
                
                // Redirecionar ap√≥s a mensagem ficar vis√≠vel
                setTimeout(() => {
                    console.log('üîÑ Redirecionando para login...');
                    window.location.href = 'login.html';
                }, 3000);
                
            } else {
                throw new Error(result.error);
            }
            
        } catch (error) {
            console.error('‚ùå Erro no cadastro:', error);
            let errorMessage = 'Erro ao fazer cadastro. Tente novamente.';
            
            if (error.message.includes('Este email j√° est√° cadastrado no sistema. Use outro email ou fa√ßa login.')) {
                errorMessage = 'Este email j√° est√° cadastrado no sistema. Use outro email ou fa√ßa login.';
            } else if (error.message.includes('matr√≠cula')) {
                errorMessage = 'Esse Login j√° est√° em uso.';
            } else if (error.message.includes('NetworkError')) {
                errorMessage = 'Erro de conex√£o. Verifique o servidor.';
            }
            
            showMessage('‚ùå ' + errorMessage, 'error', 5000);
        } finally {
            isProcessing = false;
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Cadastrar';
                registerBtn.style.opacity = '1';
            }
        }
    }

    function clearForm(inputs) {
        Object.values(inputs).forEach(input => {
            if (input) input.value = '';
        });
    }

    function getFormInputs(version = 'desktop') {
        const prefix = version === 'mobile' ? 'Mobile' : 'Desktop';
        return {
            fullName: document.getElementById(`fullName${prefix}`),
            email: document.getElementById(`email${prefix}`),
            username: document.getElementById(`username${prefix}`),
            password: document.getElementById(`password${prefix}`),
            confirmPassword: document.getElementById(`confirmPassword${prefix}`)
        };
    }

    function validateData(inputs) {
        for (let [key, input] of Object.entries(inputs)) {
            if (!input || !input.value.trim()) {
                return { 
                    isValid: false, 
                    message: `O campo ${getFieldName(key)} √© obrigat√≥rio` 
                };
            }
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(inputs.email.value.trim())) {
            return { 
                isValid: false, 
                message: 'Por favor, insira um email v√°lido' 
            };
        }

        if (inputs.password.value.length < 6) {
            return { 
                isValid: false, 
                message: 'A senha deve ter pelo menos 6 caracteres' 
            };
        }

        if (inputs.password.value !== inputs.confirmPassword.value) {
            return { 
                isValid: false, 
                message: 'As senhas n√£o coincidem' 
            };
        }

        return { isValid: true, message: '' };
    }

    function getFieldName(key) {
        const fieldNames = {
            fullName: 'Nome Completo',
            email: 'E-mail',
            username: 'Usu√°rio',
            password: 'Senha',
            confirmPassword: 'Confirmar Senha'
        };
        return fieldNames[key] || key;
    }

    // FUN√á√ÉO √öNICA showMessage - CORRIGIDA
    function showMessage(message, type = 'info', duration = 3000) {
        console.log('üí¨ Mostrando mensagem:', message, 'Dura√ß√£o:', duration);
        
        // Remover mensagens anteriores
        const existingMessages = document.querySelectorAll('.custom-message');
        existingMessages.forEach(msg => {
            msg.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (msg.parentElement) {
                    msg.remove();
                }
            }, 300);
        });

        // Aguardar um pouco antes de mostrar nova mensagem
        setTimeout(() => {
            // Criar mensagem
            const messageDiv = document.createElement('div');
            messageDiv.className = `custom-message custom-message-${type}`;
            
            // Bot√£o de fechar
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '‚úï';
            closeButton.onclick = function() {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 300);
            };
            
            const messageText = document.createElement('div');
            messageText.textContent = message;
            messageText.style.cssText = `
                flex: 1;
                font-size: 16px;
                font-weight: bold;
            `;
            
            messageDiv.appendChild(messageText);
            messageDiv.appendChild(closeButton);
            
            document.body.appendChild(messageDiv);
            
            console.log('‚úÖ Mensagem exibida:', message);
            
            // Auto-remover ap√≥s o tempo especificado
            if (duration > 0) {
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.style.animation = 'slideOut 0.5s ease';
                        setTimeout(() => {
                            if (messageDiv.parentElement) {
                                messageDiv.remove();
                                console.log('‚úÖ Mensagem removida automaticamente');
                            }
                        }, 500);
                    }
                }, duration);
            }
        }, 100);
    }

    // Google OAuth
    async function registerWithGoogle() {
        try {
            console.log('üîê Iniciando cadastro com Google...');
            
            const token = await new Promise((resolve, reject) => {
                if (typeof google === 'undefined') {
                    reject('Google Identity Services n√£o carregado');
                    return;
                }
                
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: "432080672502-ba91tog3jvoc6c0mac01iq2b5k5q3mb1.apps.googleusercontent.com",
                    scope: "email profile openid",
                    callback: (response) => {
                        if (response.access_token) {
                            resolve(response.access_token);
                        } else {
                            reject('Usu√°rio cancelou o cadastro');
                        }
                    },
                });
                client.requestAccessToken();
            });

            console.log('‚úÖ Token Google obtido, enviando para API...');
            
            const response = await fetch("http://localhost:3000/api/auth/google", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token }),
            });

            const data = await response.json();
            console.log('üì• Resposta da API:', data);

            if (data.success) {
                localStorage.setItem("authToken", data.token);
                localStorage.setItem("userData", JSON.stringify(data.user));
                
                showMessage(`üéâ Cadastro realizado! Bem-vindo(a), ${data.user.nome}!`, 'success', 3000);
                
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 3000);
                
            } else {
                console.log('‚ùå Erro no cadastro Google:', data.error);
                
                if (data.error.includes('j√° est√° cadastrado')) {
                    showMessage(`‚ùå ${data.error} V√° para a p√°gina de login.`, 'error', 5000);
                } else {
                    showMessage(`‚ùå ${data.error || 'Erro no cadastro com Google'}`, 'error', 5000);
                }
            }

        } catch (error) {
            console.error("Erro no cadastro Google:", error);
            
            if (error.message.includes('cancelou')) {
                showMessage('‚ö†Ô∏è Cadastro com Google cancelado', 'warning', 3000);
            } else {
                showMessage('‚ùå Erro no cadastro com Google: ' + error.message, 'error', 5000);
            }
        }
    }
</script>
</body>
</html>